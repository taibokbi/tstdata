<!DOCTYPE html>
<html dir="rtl" lang="ar">
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   إدارة مكتبة المسجد
  </title>
  <style>
   :root {
            --primary-color: #087f5b; --secondary-color: #b8860b; --background-color: #f8f9fa;
            --card-background-color: #ffffff; --text-color: #343a40; --border-color: #dee2e6;
            --danger-color: #d9480f; --danger-hover: #c9400a; --success-color: var(--primary-color);
            --success-hover: #077251; --info-color: #1c7ed6; --info-hover: #1971c2;
        }
        @font-face {
            font-family: 'Tajawal';
            src: url('https://fonts.gstatic.com/s/tajawal/v9/Iura6YBj_oCad4k1nzSBC45I.woff2') format('woff2');
            font-weight: 400; font-style: normal; font-display: swap;
        }
        body {
            font-family: 'Tajawal', sans-serif; background-color: var(--background-color); color: var(--text-color);
            margin: 0; padding: 25px;
        }
        .container {
            width: 100%; max-width: 900px; margin: auto; background: var(--card-background-color);
            padding: 30px 40px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-top: 5px solid var(--primary-color);
        }
        h1, h2 {
            color: var(--primary-color); text-align: center; border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px; margin-bottom: 25px;
        }
        h2 { font-size: 1.5em; margin-bottom: 20px; }
        
        /* Login Screen */
        #login-screen { text-align: center; max-width: 400px; margin: 10vh auto; }
        #login-form input {
            padding: 12px 15px; font-size: 1.1em; width: 100%; border: 1px solid var(--border-color);
            border-radius: 8px; margin-bottom: 15px; font-family: inherit; box-sizing: border-box; transition: all 0.3s;
        }
        #login-form input:focus { outline: none; border-color: var(--secondary-color); box-shadow: 0 0 8px rgba(184, 134, 11, 0.2); }
        
        /* Admin Panel */
        #admin-panel { display: none; }
        .form-section { background: #f8f9fa; padding: 25px; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 30px; }
        .form-section h2 { margin-top: 0; padding-bottom: 10px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-grid .full-width { grid-column: 1 / -1; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.95em; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 8px; box-sizing: border-box;
            font-family: inherit; font-size: 1em; background-color: #fff; transition: all 0.3s;
        }
        .form-group textarea { min-height: 100px; resize: vertical; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: var(--secondary-color); box-shadow: 0 0 8px rgba(184, 134, 11, 0.2);
        }

        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.05em; font-weight: bold; transition: all 0.2s; font-family: inherit; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
        .btn-primary { background-color: var(--info-color); color: white; } .btn-primary:hover { background-color: var(--info-hover); }
        .btn-success { background-color: var(--success-color); color: white; } .btn-success:hover { background-color: var(--success-hover); }
        .btn-danger { background-color: var(--danger-color); color: white; } .btn-danger:hover { background-color: var(--danger-hover); }
        .action-buttons { display: flex; gap: 8px; }
        .action-buttons .btn { padding: 6px 12px; font-size: 0.85em; }

        .book-list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border-bottom: 1px solid var(--border-color); }
        .book-list-item:last-child { border-bottom: none; }
        .book-details { flex-grow: 1; padding-left: 15px; } .book-details .title { font-weight: bold; color: var(--text-color); }
        .book-details .author { font-size: 0.9em; color: #6c757d; }
        .category-manage-section { margin-bottom: 25px; }
        .category-manage-section h3 { border-bottom: 2px solid var(--primary-color); padding-bottom: 8px; margin-bottom: 15px; color: var(--text-color); }

        /* --- EDIT MODAL STYLES --- */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1050; justify-content: center; align-items: center; }
        .modal-content { background: #fff; padding: 30px; border-radius: 10px; max-width: 700px; width: 90%; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 20px; }
        .modal-close-btn { font-size: 2em; line-height: 1; color: #888; cursor: pointer; background: none; border: none; }
        #image-preview { max-width: 150px; height: auto; display: block; margin: 10px auto; border: 1px solid #ccc; padding: 5px; }

        @media (max-width: 600px) {
            .form-grid { grid-template-columns: 1fr; }
            .container { padding: 15px; }
        }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js">
  </script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js">
  </script>
  <script>
   const firebaseConfig = {
    apiKey: "AIzaSyCGrL1YVZwM4vIgIPSZtnao_TGS_glf3aw",
    authDomain: "book-fa11d.firebaseapp.com",
    projectId: "book-fa11d",
    storageBucket: "book-fa11d.appspot.com",
    messagingSenderId: "771215422411",
    appId: "1:771215422411:web:55723a39729e3621b3fc4e",
    measurementId: "G-EB5M3PMRWK"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  </script>
 </head>
 <body>
  <div class="container" id="main-container">
   <!-- Login Screen -->
   <div id="login-screen">
    <h1>
     لوحة تحكم المكتبة
    </h1>
    <p>
     الرجاء إدخال كلمة المرور للوصول.
    </p>
    <form id="login-form">
     <input id="password" placeholder="كلمة المرور" required="" type="password"/>
     <br/>
     <button class="btn btn-primary" type="submit">
      دخول
     </button>
    </form>
    <p id="login-error" style="color: var(--danger-color); display: none;">
     كلمة المرور غير صحيحة.
    </p>
   </div>
   <!-- Main Admin Panel -->
   <div id="admin-panel">
    <h1>
     إدارة الكتب
    </h1>
    <div class="form-section">
     <h2>
      إضافة كتاب جديد
     </h2>
     <form id="add-book-form">
      <div class="form-grid">
       <div class="form-group full-width">
        <label for="book-title">
         عنوان الكتاب
        </label>
        <input id="book-title" required="" type="text"/>
       </div>
       <div class="form-group">
        <label for="book-author">
         المؤلف
        </label>
        <input id="book-author" required="" type="text"/>
       </div>
       <div class="form-group">
        <label for="book-edition">
         الطبعة
        </label>
        <input id="book-edition" required="" type="text"/>
       </div>
       <div class="form-group">
        <label for="book-volumes">
         عدد المجلدات
        </label>
        <input id="book-volumes" required="" type="text" value="1"/>
       </div>
       <div class="form-group">
        <label for="book-category">
         القسم
        </label>
        <select id="book-category" required="">
        </select>
       </div>
       <div class="form-group full-width">
        <label for="book-description">
         نبذة عن الكتاب
        </label>
        <textarea id="book-description"></textarea>
       </div>
       <div class="form-group full-width">
        <label for="book-image">
         صورة الغلاف (اختياري)
        </label>
        <input accept="image/*" id="book-image" type="file"/>
       </div>
      </div>
      <button class="btn btn-success" style="margin-top: 20px;" type="submit">
       إضافة الكتاب
      </button>
     </form>
    </div>
    <div class="form-section">
     <h2>
      قائمة الكتب الحالية
     </h2>
     <div id="manage-book-list">
     </div>
    </div>
    <a href="index.html" style="text-align: center; display:block; margin-top: 20px; color: var(--secondary-color); font-weight: bold;" target="_blank">
     عرض صفحة المكتبة الرئيسية
    </a>
   </div>
  </div>
  <!-- Edit Book Modal -->
  <div class="modal-overlay" id="edit-modal-overlay">
   <div class="modal-content">
    <div class="modal-header">
     <h2>
      تعديل الكتاب
     </h2>
     <button class="modal-close-btn">
      ×
     </button>
    </div>
    <form id="edit-book-form">
     <input id="edit-category-index" type="hidden"/>
     <input id="edit-book-index" type="hidden"/>
     <div class="form-grid">
      <div class="form-group full-width">
       <label for="edit-book-title">
        عنوان الكتاب
       </label>
       <input id="edit-book-title" required="" type="text"/>
      </div>
      <div class="form-group">
       <label for="edit-book-author">
        المؤلف
       </label>
       <input id="edit-book-author" required="" type="text"/>
      </div>
      <div class="form-group">
       <label for="edit-book-edition">
        الطبعة
       </label>
       <input id="edit-book-edition" required="" type="text"/>
      </div>
      <div class="form-group">
       <label for="edit-book-volumes">
        عدد المجلدات
       </label>
       <input id="edit-book-volumes" required="" type="text"/>
      </div>
      <div class="form-group">
       <label for="edit-book-category-select">
        القسم
       </label>
       <select id="edit-book-category-select" required="">
       </select>
      </div>
      <div class="form-group full-width">
       <label for="edit-book-description">
        نبذة عن الكتاب
       </label>
       <textarea id="edit-book-description"></textarea>
      </div>
      <div class="form-group full-width">
       <label for="edit-book-image">
        تغيير صورة الغلاف
       </label>
       <input accept="image/*" id="edit-book-image" type="file"/>
       <img alt="Image Preview" id="image-preview" src=""/>
      </div>
     </div>
     <button class="btn btn-success" style="margin-top: 20px;" type="submit">
      حفظ التعديلات
     </button>
    </form>
   </div>
  </div>
  <script>
   document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("add-book-form");
  if (!form) return;

  form.addEventListener("submit", async function (e) {
    e.preventDefault();
    const title = document.getElementById("book-title").value;
    const author = document.getElementById("book-author").value;
    const edition = document.getElementById("book-edition").value;
    const volumes = document.getElementById("book-volumes").value;
    const category = document.getElementById("book-category").value;
    const description = document.getElementById("book-description").value;
    const imageFile = document.getElementById("book-image").files[0];
    let image = "";
    if (imageFile) {
      const reader = new FileReader();
      reader.onloadend = async () => {
        image = reader.result;
        await saveBook({ title, author, edition, volumes, category, description, image });
      };
      reader.readAsDataURL(imageFile);
    } else {
      await saveBook({ title, author, edition, volumes, category, description, image });
    }
  });

  async function saveBook(data) {
    await db.collection("books").add(data);
    alert("✅ تم حفظ الكتاب في قاعدة البيانات");
    form.reset();
    loadBooks();
  }

  async function loadBooks() {
    const bookList = document.getElementById("manage-book-list");
    const categorySelect = document.getElementById("book-category");
    const snapshot = await db.collection("books").get();
    const books = [];
    snapshot.forEach(doc => books.push({ id: doc.id, ...doc.data() }));
    const categories = [...new Set(books.map(b => b.category || "غير مصنف"))];
    categorySelect.innerHTML = "";
    categories.forEach(c => {
      const opt = new Option(c, c);
      categorySelect.appendChild(opt);
    });
    bookList.innerHTML = "";
    books.forEach(book => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${book.title}</td>
        <td>${book.author}</td>
        <td>${book.edition}</td>
        <td>${book.volumes}</td>
        <td>${book.category}</td>
        <td>
          <button onclick="editBook('${book.id}')">✏️</button>
          <button onclick="deleteBook('${book.id}')">🗑</button>
        </td>
      `;
      bookList.appendChild(row);
    });
  }

  window.editBook = async function (id) {
    const doc = await db.collection("books").doc(id).get();
    const book = doc.data();
    const newTitle = prompt("عنوان جديد:", book.title);
    if (newTitle) {
      await db.collection("books").doc(id).update({ title: newTitle });
      loadBooks();
    }
  }

  window.deleteBook = async function (id) {
    if (confirm("تأكيد حذف الكتاب؟")) {
      await db.collection("books").doc(id).delete();
      loadBooks();
    }
  }

  loadBooks();
});
  </script>
 
<script>
document.addEventListener("DOMContentLoaded", () => {
  const exportBtn = document.getElementById("export-csv");
  if (exportBtn) {
    exportBtn.addEventListener("click", async () => {
      const snapshot = await db.collection("books").get();
      const books = [];
      snapshot.forEach(doc => books.push(doc.data()));

      const csvRows = [];
      const headers = ["عنوان", "المؤلف", "الطبعة", "عدد المجلدات", "القسم", "النبذة"];
      csvRows.push(headers.join(","));

      books.forEach(book => {
        const row = [
          book.title || "",
          book.author || "",
          book.edition || "",
          book.volumes || "",
          book.category || "",
          book.description || ""
        ];
        csvRows.push(row.map(cell => `"${(cell + "").replace(/"/g, '""')}"`).join(","));
      });

      const csvContent = csvRows.join("\n");
      const blob = new Blob(["\ufeff" + csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "الكتب.csv";
      a.click();
      URL.revokeObjectURL(url);
    });
  }
});
</script>

</body>
</html>
