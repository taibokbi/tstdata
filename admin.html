
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة تحكم المكتبة</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background: #f7f8f9; margin: 0; padding: 20px; text-align: center; }
    .card { background: white; max-width: 700px; margin: auto; padding: 40px; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    input, select, textarea { width: 90%; padding: 10px; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; }
    button { padding: 10px 20px; margin-top: 10px; background: #00704A; color: white; border: none; border-radius: 5px; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 8px; border: 1px solid #ccc; }
    #logout { position: fixed; top: 20px; left: 20px; background: red; }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>
<body>
  <div id="login-section" class="card">
    <h2>لوحة تحكم المكتبة</h2>
    <p>الرجاء إدخال كلمة المرور للوصول.</p>
    <form id="login-form">
      <input type="password" id="password-input" placeholder="كلمة المرور" required />
      <br />
      <button type="submit">دخول</button>
    </form>
  </div>

  <div id="main-content" style="display:none">
    <button id="logout">تسجيل الخروج</button>
    <div class="card">
      <h2>📚 إضافة كتاب جديد</h2>
      <form id="add-book-form">
        <input id="book-title" placeholder="عنوان الكتاب" required />
        <input id="book-author" placeholder="المؤلف" required />
        <input id="book-edition" placeholder="الطبعة" />
        <input id="book-volumes" placeholder="عدد المجلدات" />
        <select id="book-category"></select>
        <textarea id="book-description" placeholder="نبذة عن الكتاب"></textarea>
        <input type="file" id="book-image" />
        <button type="submit">إضافة الكتاب</button>
      </form>
    </div>

    <div class="card">
      <h3>📤 تصدير الكتب</h3>
      <button id="export-csv">📥 تصدير كـ CSV</button>
    </div>

    <div class="card">
      <h2>📖 إدارة الكتب</h2>
      <table>
        <thead><tr><th>العنوان</th><th>المؤلف</th><th>الطبعة</th><th>المجلدات</th><th>القسم</th><th>خيارات</th></tr></thead>
        <tbody id="manage-book-list"></tbody>
      </table>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCGrL1YVZwM4vIgIPSZtnao_TGS_glf3aw",
      authDomain: "book-fa11d.firebaseapp.com",
      projectId: "book-fa11d",
      storageBucket: "book-fa11d.appspot.com",
      messagingSenderId: "771215422411",
      appId: "1:771215422411:web:55723a39729e3621b3fc4e",
      measurementId: "G-EB5M3PMRWK"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    document.addEventListener("DOMContentLoaded", function () {
      const loginSection = document.getElementById("login-section");
      const mainContent = document.getElementById("main-content");
      const loginForm = document.getElementById("login-form");
      const logoutBtn = document.getElementById("logout");

      const correctPassword = "admin123";
      if (localStorage.getItem("auth") === "1") {
        loginSection.style.display = "none";
        mainContent.style.display = "block";
      }

      if (loginForm) {
        loginForm.addEventListener("submit", function (e) {
          e.preventDefault();
          const input = document.getElementById("password-input").value;
          if (input === correctPassword) {
            localStorage.setItem("auth", "1");
            loginSection.style.display = "none";
            mainContent.style.display = "block";
            loadBooks();
          } else {
            alert("❌ كلمة المرور غير صحيحة");
          }
        });
      }

      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("auth");
        location.reload();
      });

      const form = document.getElementById("add-book-form");
      form.addEventListener("submit", async function (e) {
        e.preventDefault();
        const title = document.getElementById("book-title").value;
        const author = document.getElementById("book-author").value;
        const edition = document.getElementById("book-edition").value;
        const volumes = document.getElementById("book-volumes").value;
        const category = document.getElementById("book-category").value;
        const description = document.getElementById("book-description").value;
        const imageFile = document.getElementById("book-image").files[0];
        let image = "";
        if (imageFile) {
          const reader = new FileReader();
          reader.onloadend = async () => {
            image = reader.result;
            await saveBook({ title, author, edition, volumes, category, description, image });
          };
          reader.readAsDataURL(imageFile);
        } else {
          await saveBook({ title, author, edition, volumes, category, description, image });
        }
      });

      async function saveBook(data) {
        await db.collection("books").add(data);
        alert("✅ تم حفظ الكتاب");
        form.reset();
        loadBooks();
      }

      async function loadBooks() {
        const bookList = document.getElementById("manage-book-list");
        const categorySelect = document.getElementById("book-category");
        const snapshot = await db.collection("books").get();
        const books = [];
        snapshot.forEach(doc => books.push({ id: doc.id, ...doc.data() }));
        const categories = [...new Set(books.map(b => b.category || "غير مصنف"))];
        categorySelect.innerHTML = "";
        categories.forEach(c => {
          const opt = new Option(c, c);
          categorySelect.appendChild(opt);
        });
        bookList.innerHTML = "";
        books.forEach(book => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${book.title}</td>
            <td>${book.author}</td>
            <td>${book.edition}</td>
            <td>${book.volumes}</td>
            <td>${book.category}</td>
            <td>
              <button onclick="editBook('${book.id}')">✏️</button>
              <button onclick="deleteBook('${book.id}')">🗑</button>
            </td>
          `;
          bookList.appendChild(row);
        });
      }

      window.editBook = async function (id) {
        const doc = await db.collection("books").doc(id).get();
        const book = doc.data();
        const newTitle = prompt("عنوان جديد:", book.title);
        if (newTitle) {
          await db.collection("books").doc(id).update({ title: newTitle });
          loadBooks();
        }
      }

      window.deleteBook = async function (id) {
        if (confirm("تأكيد الحذف؟")) {
          await db.collection("books").doc(id).delete();
          loadBooks();
        }
      }

      document.getElementById("export-csv").addEventListener("click", async () => {
        const snapshot = await db.collection("books").get();
        const books = [];
        snapshot.forEach(doc => books.push(doc.data()));
        const csvRows = [];
        const headers = ["العنوان", "المؤلف", "الطبعة", "المجلدات", "القسم", "النبذة"];
        csvRows.push(headers.join(","));
        books.forEach(book => {
          const row = [
            book.title || "", book.author || "", book.edition || "", book.volumes || "",
            book.category || "", book.description || ""
          ];
          csvRows.push(row.map(cell => `"${(cell + "").replace(/"/g, '""')}"`).join(","));
        });
        const blob = new Blob(["\ufeff" + csvRows.join("\n")], { type: "text/csv;charset=utf-8;" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "الكتب.csv";
        a.click();
        URL.revokeObjectURL(url);
      });

      if (localStorage.getItem("auth") === "1") {
        loadBooks();
      }
    });
  </script>
</body>
</html>
