// Ø³ÙƒØ±ÙŠØ¨Øª Ù„Ø¥Ø¶Ø§ÙØ© ØµÙˆØ±Ø© Ù„ÙƒÙ„ ÙƒØªØ§Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Google Books API
// ÙŠØ¹Ù…Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¯Ø§Ø®Ù„ ØµÙØ­Ø© admin.html

async function autoFillBookImages() {
  const categoriesSnapshot = await db.collection("categories").get();

  for (const doc of categoriesSnapshot.docs) {
    const categoryRef = doc.ref;
    const data = doc.data();
    const books = data.books || [];

    const updatedBooks = await Promise.all(books.map(async (book) => {
      if (book.image && book.image.trim() !== "") return book;

      const query = `intitle:${book.title} inauthor:${book.author}`;
      const url = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}`;

      try {
        const res = await fetch(url);
        const result = await res.json();

        const image = result.items?.[0]?.volumeInfo?.imageLinks?.thumbnail || "";

        return { ...book, image };
      } catch (e) {
        console.error(`âŒ ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„ÙƒØªØ§Ø¨: ${book.title}`, e);
        return book;
      }
    }));

    await categoryRef.update({ books: updatedBooks });
    console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ± ÙÙŠ Ø§Ù„Ù‚Ø³Ù…: ${doc.id}`);
  }

  alert("ğŸ‰ ØªÙ… ØªØ­Ø¯ÙŠØ« ØµÙˆØ± Ø§Ù„ÙƒØªØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹!");
}

// Ø£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø¯Ù…Ù†
const initBtn = document.createElement("button");
initBtn.textContent = "ØªØ­Ø¯ÙŠØ« ØµÙˆØ± Ø§Ù„ÙƒØªØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹";
initBtn.className = "btn btn-info";
initBtn.style.marginTop = "10px";
initBtn.onclick = autoFillBookImages;

document.getElementById("initialization-section").appendChild(initBtn);
document.getElementById("initialization-section").style.display = "block";
